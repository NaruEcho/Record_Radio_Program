name: Transcribe MP3 Files

on:
  workflow_dispatch:    # 手動トリガーを有効にする設定

jobs:
  transcribe:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Find MP3 files without transcript
      id: find_mp3_files
      run: |
        mp3_files=$(find . -type f -name "*.mp3")
        files_to_process=()
        for file in $mp3_files; do
          srt_file="${file%.mp3}.srt"
          if [ ! -f "$srt_file" ]; then
            files_to_process+=("$file")
          fi
        done
        files_output=$(printf "%s\n" "${files_to_process[@]}")
        echo "files=$files_output" >> $GITHUB_ENV

    - name: Transcribe files
      if: steps.find_mp3_files.outputs.files != ''
      uses: appleboy/whisper-action@v0.1.1
      with:
        model: small
        audio_path: ${{ steps.find_mp3_files.outputs.files }}
        output_format: srt
        output_folder: transcripts
        print_progress: true
        translate: false

    - name: Save transcript as .src
      if: steps.find_mp3_files.outputs.files != ''
      run: |
        for file in ${{ steps.find_mp3_files.outputs.files }}; do
          transcript_file="transcripts/${file%.mp3}.txt"
          if [ -f "$transcript_file" ]; then
            mv "$transcript_file" "${file%.mp3}.src"
          fi
        done

    - name: Commit and push changes
      if: steps.find_mp3_files.outputs.files != ''
      run: echo done
