<?php
 function premium_init() { if (rf_product_check() != "P") { return false; } $parea = premium_getarea(); $no = rf_convjp($parea); if ($no != 0) { return false; } return $parea; } function premium_getpref() { global $premium_area; global $pref_code; $no = rf_convjp($premium_area); if ($no != 0) { $parea = $pref_code[$no]; } else { $parea = ""; } return $parea; } function premium_setarea($no) { global $premium_area; global $area_code; global $nowarea; $premium_area = sprintf("JP%d", $no); $area_code = $premium_area; $pref = premium_getpref(); $nowarea = "$area_code,$pref"; } function premium_putarea_fl($fl, $area) { $parea = strtoupper($area); $no = rf_convjp($parea); if ($fl != "") { file_put_contents($fl, $parea, LOCK_EX); premium_setarea($no); } return true; } function premium_getarea_fl($fil) { global $home_area_code; if (!file_exists($fil)) { $parea = $home_area_code; premium_putarea_fl($fil, $parea); } $area = file_get_contents($fil); $parea = strtoupper($area); $no = rf_convjp($parea); if ($no == 0) { fin_unlink($fil); $no = 1; $parea = "JP1"; } premium_setarea($no); return $parea; } function premium_putarea($area) { global $premiumareafile; $ret = premium_putarea_fl($premiumareafile, $area); return $ret; } function premium_getarea() { global $premiumareafile; $ret = premium_getarea_fl($premiumareafile); return $ret; } function premium_mail($no,$m) { global $premium; global $premium_mail; global $premium_area; global $home_area_code; global $send_mail_mode; global $send_mail_line_mode; $dt = date("Y/m/d H:i:s"); $mes = "radiko premium ログイン状況 \r\n\r\n"; switch($no) { case 1: $subj = "Enabled premium login"; $mes = $mes . "ラジコプレミアムへのログインは有効です。\r\n"; break; case 2: $subj = "Disabled premium login"; $mes = $mes . "ラジコプレミアムへのログインは無効です。\r\n"; break; case 3: $subj = "Expired premium login"; $mes = $mes . "ラジコプレミアムは期限切れです。\r\n"; break; case 4: $subj = "Succeeded premium login"; $mes = $mes . "ラジコプレミアムへの再ログインに成功しました。\r\n"; break; case 5: $subj = "Failed premium login"; $mes = $mes . "ラジコプレミアムへの再ログインに失敗しました。\r\n"; break; case 6: $subj = "Need premium relogin"; $mes = $mes . "ラジコプレミアムへログインしてから $m 日経過しています。\r\n"; break; default: $subj = "????? premium login ($no)"; $mes = $mes . "NO ミス\r\n"; break; } $mes = $mes . "\r\n"; $mes = $mes . "date           : $dt \r\n"; $mes = $mes . "id             : $premium_mail \r\n"; $mes = $mes . "premium        : $premium \r\n"; $mes = $mes . "premium area   : $premium_area \r\n"; $mes = $mes . "home area code : $home_area_code \r\n"; if ($send_mail_mode > 0 ) { free_mail($subj,$mes); } if ($send_mail_line_mode > 0 ) { $mes= $subj."\r\n".$mes; rfgw_line_notify(0,$mes); } } function premium_check_timeout() { global $premium; global $premium_mail; global $premium_area; global $cookiefile; global $premiumareafile; global $home_area_code; global $premium_autologin; global $premium_lifetime; $p_area = $premium_area; $ret = premium_logincheck(); if ($ret === true) { echo_prn(1,"radiko_premium_login OK"); if ($premium_area == "") { premium_getarea(); } } else { if($premium_autologin != "y") { echo_prn(1, "ラジコプレミアムのオートログインが有効ではありません。"); echo_prn(1, "ラジコプレミアムにログインしていません。"); return false; } premium_login(); if (premium_logincheck() === false) { echo_prn(1, "failed radiko_premium_login : $premium_mail"); premium_mail(5,""); return false; } echo_prn(1, "succeeded radiko_premium_login : $premium_mail"); } premium_putarea($p_area); if ($premium_area == "") { premium_getarea(); } return true; } function premium_check() { global $premium; global $premium_area; global $premium_autologin; global $cookiefile; global $premiumareafile; global $home_area_code; if (rf_product_check() != "P") { return -1; } if ($premium != 1 && $premium != 2) { return 0; } return $premium; } function premium_login() { global $opt_login; global $login_url; global $loginfile; global $cookiefile; global $radikosessionfile; global $premium_mail; global $premium_password; global $premium_area; global $area_code; global $home_area_code; global $auth_token_dat; global $premium; $rfriends_mes = "ラジオ録音ツール"; $pw = $premium_password; if ($pw == "") { echo_msg(2,"premium_passwordが設定されていません。"); echo_msg(2,"premium_passwordを設定してください。"); return false; } $opt = $opt_login . " --post-data=\"mail=$premium_mail&pass=$pw\"" . " --save-cookie=" . $cookiefile; $url = $login_url; $fl = $loginfile; switch($premium) { case 1: if (rf_wget($url, $fl, $opt) === false) { fin_unlink($cookiefile); fin_unlink($radikosessionfile); echo_msg(2,"premium_login failed : $premium_mail"); return false; } $json_data = json_decode(file_get_contents($fl),true); $paid_member = 0; $areafree = 0; $radiko_session = ""; if (array_key_exists("paid_member", $json_data)) { $paid_member = $json_data["paid_member"] + 0; } if (array_key_exists("areafree", $json_data)) { $areafree = $json_data["areafree"] + 0; } if (array_key_exists("radiko_session", $json_data)) { $radiko_session = $json_data["radiko_session"]; } if ($paid_member != 1 || $areafree != 1) { echo_msg(2,"premium_login failed : $premium_mail,$paid_member,$areafree,$radiko_session"); fin_unlink($cookiefile); fin_unlink($radikosessionfile); return false; } file_put_contents($radikosessionfile,$radiko_session); echo_msg(2,"radiko_session : $radiko_session"); break; case 2: $ret = 0; rf_touch("$cookiefile"); echo_msg(2, "test用に空の $cookiefile を作成しました。"); break; default: return false; break; } fin_unlink($fl); if (!file_exists($cookiefile)) { fin_unlink($cookiefile); fin_unlink($radikosessionfile); echo_msg(2,"premium_login failed : $cookiefile"); return false; } $pref = premium_getpref(); if ($pref == "") { $premium_area = $home_area_code; premium_putarea($premium_area); } fin_unlink($auth_token_dat); auth_ex(0); echo_msg(2,"premium login successful"); return true; } function premium_logout() { global $opt_logout; global $logout_url; global $logoutfile; global $cookiefile; global $radikosessionfile; global $premium; global $premium_area; global $home_area_code; switch($premium) { case 1: if (!file_exists($cookiefile)) return true; $r_radiko_session = file_get_contents($radikosessionfile); $opt = $opt_logout . " --post-data=\"radiko_session=$r_radiko_session\"" . " --load-cookies ".$cookiefile; $url = $logout_url; $fl = $logoutfile; rf_wget($url, $fl, $opt); fin_unlink($cookiefile); fin_unlink($radikosessionfile); fin_unlink($fl); auth_ex(0); break; case 2: $fl = $logoutfile; fin_unlink($cookiefile); fin_unlink($fl); break; default: fin_unlink($cookiefile); fin_unlink($radikosessionfile); return true; } $premium_area = $home_area_code; premium_putarea($premium_area); return true; } function premium_logincheck() { global $premium; global $premium_autologin; global $opt_logincheck; global $logincheck_url; global $logincheckfile; global $cookiefile; global $radikosessionfile; global $premium; global $premium_lifetime; if(!file_exists($cookiefile)) { return false; } if ($premium == 2) { return true; } if ($premium != 1) { return false; } if(!file_exists($radikosessionfile)) { fin_unlink($cookiefile); return false; } $sessiondate = filemtime($radikosessionfile); $session = intval( (time() - $sessiondate) / (60*60*24) ); echo_msg(2,"session date : ". date("Y/m/d H:i:s",$sessiondate)." ($session)"); echo_msg(2,"premium_lifetime : $premium_lifetime"); if ($session > $premium_lifetime) { echo_msg(2,"premium logincheck (expired)"); fin_unlink($cookiefile); fin_unlink($radikosessionfile); return false; } $at = rf_radiko_hls(0,1); if ($at === false) { echo_msg(2,"premium logincheck (timeout?)"); fin_unlink($cookiefile); fin_unlink($radikosessionfile); return false; } echo_msg(2,"premium logincheck OK"); return true; return true; } function rf_set_premium_home() { global $home_area_code; global $premium_home_area_code; $premium_home_area_code = $home_area_code; if (premium_check() > 0) { $sta = rf_get_keyword('premium_main_station'); if (count_73($sta) > 0) { $area = $sta[0]; $no = rf_convjp($area); if ($no > 0) { $premium_home_area_code = $area; } } } } 