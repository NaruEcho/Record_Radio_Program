<?php
 function rf_get_lang_rsv() { global $tmpdir; global $scrdir; global $radiru_gogaku_url; $ofl = $scrdir."lang.dat"; $nfl = $tmpdir."lang.dat"; if (!file_exists($nfl)) { $ret = rf_copy($ofl,$nfl); if ($ret === false) return false; } $lang_dat = file($nfl); $lang = array(); foreach($lang_dat as $dat) { $lang[] = trim($dat); } return $lang; } function rf_put_lang_rsv($lang_dat) { global $tmpdir; global $scrdir; global $radiru_gogaku_url; $ofl = $scrdir."lang.dat"; $nfl = $tmpdir."lang.dat"; $lang = array(); foreach($lang_dat as $dat) { $lang[] = $dat."\n"; } $ret = file_put_contents($nfl, $lang, LOCK_EX); if ($ret !== false) return; $ret = rf_copy($ofl,$nfl); } function convert_encoding_82($html) { return $html; } function rf_get_lang() { global $tmpdir; global $scrdir; global $radiru_gogaku_url; global $radiru_gogaku_url_s; $url = $radiru_gogaku_url; $lang = array(); $html = rf_get_html($url,2); if ($html === false) { echo_prn(1, "failed get lang_url"); $lang_dat = rf_get_lang_rsv(); if ($lang_dat === false) return $lang; echo_prn(1, "recovered lang_url"); return $lang_dat; } $html = convert_encoding_82($html) ; $dom = new DOMDocument; @$dom->loadHTML($html); $xml = simplexml_import_dom($dom); $idx= $xml->xpath('//div[@id="indexMainList"]'); $pgm = $idx[0]->ul[0]->li; foreach ($pgm as $p) { $p2 = $p->a; $kz = $p2->img->attributes()->alt[0]; $u = $p2->attributes()->href[0]; if (substr($u,0,4) != "http") $u = $radiru_gogaku_url_s . $u; $lang[] = "$kz,$u"; } rf_put_lang_rsv($lang); return $lang; } function rf_get_lang_detail($url) { $kouza = array(); $html2 = rf_get_html($url,2); if ($html2 === false) { return $kouza; } $html2 = convert_encoding_82($html2) ; $dom2 = new DOMDocument; @$dom2->loadHTML($html2); $xml2 = simplexml_import_dom($dom2); $idx2= $xml2->xpath('//div[@id="listRadio"]'); $pgm2 = $idx2[0]->ul[0]->li; foreach ($pgm2 as $p2) { @$p22 = $p2->div->div[1]->a; if ($p22 == "") continue; @$u2 = $p22->attributes()->href[0]; if ($u2 == "") continue; $k2 = explode("=", $u2); if (count_73($k2) != 2) continue; $kouza[] = substr($k2[1], 0, 4); } return $kouza; } function ond_date($onair_date, $open_time) { $od = $onair_date; $ot = strtotime($open_time); $oty = date("Y", $ot); $dd = str_replace("放送", "", $od); $p = array("(日)","(月)","(火)","(水)","(木)","(金)","(土)"); $dd = str_replace($p, "", $dd); $ampm = ""; if (mb_strpos($dd, "午前") !==false) { $ampm = "a"; $dd = str_replace("午前", "", $dd); } if (mb_strpos($dd, "午後") !==false) { $ampm = "p"; $dd = str_replace("午後", "", $dd); } if (mb_strpos($dd, '年') === false) { $dd = str_replace('月', '/', $dd); $dd = str_replace('日', ' ', $dd); $dd = $oty."/".$dd; if (strtotime($dd) > $ot) { $oty = $oty - 1; $dd = $oty."/".$dd; } } else { $dd = str_replace('年', '/', $dd); $dd = str_replace('月', '/', $dd); $dd = str_replace('日', ' ', $dd); } $dt = strtotime($dd); if ($ampm == "p") { $dt = $dt + 12*3600; } return $dt; } function ond_check($open_time, $close_time) { $opt = strtotime($open_time); $clt = strtotime($close_time); $nwt = time(); if ($nwt>= $opt && $nwt <= $clt) { return true; } else { return false; } } function get_gogaku_code($gmode) { global $radiru_gogaku_url; global $radiru_gogaku_code; $radiru_gogaku_code = array(); $url = $radiru_gogaku_url; $lang = rf_get_lang(); $nmax = count_73($lang); if ($nmax < 2) { return $radiru_gogaku_code; } switch ($gmode) { case 0: $st = 0; $en = $nmax; break; case 1: $st = 0; $en = 1; break; case 2: $st = 1; $en = $nmax; break; default: $st = 0; $en = 0; break; } for ($i=$st; $i<$en; $i++) { $kz = explode(",", $lang[$i]); $url = $kz[1]; $kouza = rf_get_lang_detail($url); $radiru_gogaku_code = array_merge($radiru_gogaku_code,$kouza); } return $radiru_gogaku_code; } function ond_chconv2($media_code) { $ret = "r"; $mcode = explode(",", $media_code); foreach($mcode as $mc) { $mc = (int)$mc; if ($mc == 5) $ret .= "1"; if ($mc == 6) $ret .= "2"; if ($mc == 7) $ret .= "3"; } $n = strlen($ret); if ($n < 1) return ""; return $ret; } function ond_chconv($media_code) { $ret = ""; $mcode = explode(",", $media_code); foreach($mcode as $mc) { $mc = (int)$mc; if ($mc == 5) $ret .= "r1,"; if ($mc == 6) $ret .= "r2,"; if ($mc == 7) $ret .= "r3,"; } $n = strlen($ret); if ($n < 3) return ""; if (substr($ret,$n-1,1) == ",") { $ret = substr($ret,0,$n-1); } return $ret; } function ond_chcheck($site_id, $media_code, $mcode_sel) { global $radiru_gogaku_code; switch($mcode_sel) { case 0: return true; break; case 5: break; case 6: break; case 7: break; case -1: foreach ($radiru_gogaku_code as $id) { if ($site_id == $id) { return true; } } return false; break; default: return false; break; } $mcode = explode(",", $media_code); foreach($mcode as $mc) { if ((int)$mc == (int)$mcode_sel) { return true; } } return false; } function ond_list($url, $mcode_sel) { global $schdir; $ond = array(); if (($sch = rf_get_html($url,2)) === false) { return $ond; } $json = json_decode($sch, true); $cnt = count_73($json["data_list"]); $ttl = 0; for ($i=0; $i<$cnt; $i++) { $st = $json["data_list"][$i]; $site_id = $st["site_id"]; $media_code = $st["media_code"]; $ret = ond_chcheck($site_id, $media_code, $mcode_sel); if ($ret === false) { continue; } $program_name = $st["program_name"]; $corner_id = $st["corner_id"]; $corner_name = $st["corner_name"]; $thumbnail_p = $st["thumbnail_p"]; $thumbnail_c = $st["thumbnail_c"]; $detail_json = $st["detail_json"]; $open_time = $st["open_time"]; $close_time = $st["close_time"]; $onair_date = $st["onair_date"]; $link_url = $st["link_url"]; $rt = ond_check($open_time, $close_time); if ($rt == true) { $ond_l[0] = ""; } else { $ond_l[0] = "X"; } $ond_l[1] = date("Y/m/d", ond_date($onair_date, $open_time)); $ond_l[2] = fn_edit($program_name); $ond_l[3] = fn_edit($corner_name); $ond_l[4] = $detail_json; $ond_l[5] = $thumbnail_p; $ond_l[6] = $site_id; $ond_l[7] = $media_code; $ond[$ttl] = $ond_l; $ttl++; } return $ond; } function ond_detail($nm) { $url = $nm[4]; $pic = $nm[5]; $ond = array(); if (($sch = rf_get_html($url,2)) === false) { return $ond; } $json = json_decode($sch, true); @$json_detail = $json["main"]["detail_list"]; $cnt = count_73($json_detail); $ttl = 0; if ($cnt < 1) { echo_msg(2, "録音できる番組がありません。"); rf_pause(); return $ond; } for ($j=0; $j < $cnt; $j++) { $st = $json_detail[$j]["file_list"]; $cnt2 = count_73($st); for ($k=0; $k<$cnt2; $k++) { $st2 = $st[$k]; $seq = $st2["seq"]; $file_id = $st2["file_id"]; $file_title = $st2["file_title"]; $file_title_sub = $st2["file_title_sub"]; $file_name = $st2["file_name"]; $open_time = $st2["open_time"]; $close_time = $st2["close_time"]; $aa_contents_id = $st2["aa_contents_id"]; $aa_measurement_id = $st2["aa_measurement_id"]; $aa_vinfo1 = $st2["aa_vinfo1"]; $aa_vinfo2 = $st2["aa_vinfo2"]; $aa_vinfo3 = $st2["aa_vinfo3"]; $aa_vinfo4 = $st2["aa_vinfo4"]; $onair_date = $st2["onair_date"]; $share_url = $st2["share_url"]; $od = ond_date($onair_date, $open_time); $onair_date2 = date("Y/m/d", $od); $id = explode(";", $aa_contents_id); if (substr($id[4], 0, 2) == "99") { $t1 = date("Ymd", $od)."0000"; $t2= "0000"; } else { $id2 = explode("_", $id[4]); $t1 = date("YmdHi", strtotime($id2[0])); $t2 = date("Hi", strtotime($id2[1])); } $rt = ond_check($open_time, $close_time); if ($rt == true) { $nm[0] = ""; } else { $nm[0] = "X"; } $nm[1] = explode(",", $id[2])[0]; $nm[2] = $t1."_".$t2; $nm[3] = $file_title; $nm[4] = $file_title_sub; $nm[5] = $file_name; $nm[6] = $pic; $ond[$ttl] = $nm; $ttl++; } } $st = array(); foreach ($ond as $key => $value) { $st[$key] = $value[2]; } array_multisort($st, SORT_DESC, $ond); return $ond; } function ond_select($ond, $mcode_sel) { global $tmpdir; global $ex_radiru_vod; global $ex_radiru_gogaku; global $radiru_vod_recdir; global $radiru_vod_genre; global $radiru_gogaku_lang; global $rec_extension; global $scr_width; global $ui_mode; $ttl = count_73($ond); if ($ttl < 1) { echo_msg(2, "番組がありません。"); rf_pause(); return -1; } $flist = array(); foreach ($ond as $nm) { $dtm = substr($nm[1], 2); if (strlen($nm[3]) <= 0) { $flst = $nm[2]; } else { $flst = $nm[2]."($nm[3])"; } if ($mcode_sel == -1) { } $bch = ond_chconv2($nm[7]); if ($ui_mode == 2) { $addsp = 4 - strlen($bch); if ($addsp > 0) { $bch .= str_repeat("&nbsp;",$addsp); } } else { $bch = substr($bch."    ",0,4); } $title = $dtm." $bch ".$flst; $val = htmlspecialchars(implode(',', $nm), ENT_COMPAT | ENT_HTML401, 'UTF-8'); $flist[] = array('title' => $title,'val' => $val); } $cnt = count_73($flist); switch ($mcode_sel) { case 0: $mc = "all"; break; case 5: $mc = "r1"; break; case 6: $mc = "r2"; break; case 7: $mc = "r3"; break; case -1: $mc = "ゴガク"; break; default: $mc = "?"; break; } $opt = array( "title" => "聞き逃し一覧（$mc $cnt 件）", "input_type" => 0, "page_control" => 1, "return_mes" => "終了", "input_mes" => "番組を選択してください", "mode" => 1, "multi" => 0, "confirm" => 0, "ht_selid" => "selpgm" ); $no1 = rf_pctl_disp($flist, $opt); $ans = $no1[0]; if ($ans == "r") { return 1; } if ($ans == "e") { echo_msg(2, "入力エラー"); rf_pause(); return 1; } if ($ans == "z") { echo_msg(2, "リストが空です"); rf_pause(); return 1; } $no = $no1[0]; $no = $no - 1; $nm = $ond[$no]; $pic = $nm[5]; $pgm = $nm[2]; $ond2 = ond_detail($nm); $no2 = ond_select_detail($nm,$ond2); $ans = $no2[0]; if ($ans == "r") { if ($ttl == 1) { return 1; } return 0; } if ($ans == "e") { echo_msg(2, "入力エラー"); rf_pause(); return 0; } if ($ans == "z") { echo_msg(2, "リストが空です"); rf_pause(); return 0; } $cnt = count_73($no2); $wdat = array(); for ($i=0;$i<$cnt;$i++) { $j = $no2[$i]; $nm2 = $ond2[$j - 1]; echo_msg(2,"$j ".$nm2[3]); $wdat[] = ond_select_wdat($nm2); } ond_select_ex($wdat,$mcode_sel); } function ond_select_detail_s($nm,$ond2) { global $tmpdir; global $ex_radiru_vod; global $ex_radiru_gogaku; global $radiru_vod_recdir; global $radiru_vod_genre; global $radiru_gogaku_lang; global $rec_extension; global $scr_width; global $multi_sw; $pic = $nm[5]; $pgm = $nm[2]; $ttl2 = count_73($ond2); if ($ttl2 < 1) { return -1; } $tnm = $nm[2]; if (strlen($nm[3]) > 0) { $tnm = "$tnm($nm[3])"; } $tnm2 = rf_strimwidth($tnm, 0, $scr_width-12); $no2 = array(); $flist2 = array(); foreach ($ond2 as $nm) { if ($nm[0] == "") { $nm[0] = "_"; } $dtx = sprintf( "%s/%s/%s", substr($nm[2], 2, 2), substr($nm[2], 4, 2), substr($nm[2], 6, 2) ); $pgm2 = $nm[3]; if (mb_substr($pgm2,0,mb_strlen($pgm)) == $pgm) { $pgm2 = mb_substr($pgm2, mb_strlen($pgm)); $pgm2 = mb_convert_kana($pgm2,'s'); $pgm2 = trim($pgm2); if (strlen($pgm2) == 0) { $pgm2 = $pgm; } } $ttl = "$dtx $pgm2"; $val = ond_select_wdat($nm); $flist2[] = array('title' => $ttl,'val' => $val); } return $flist2; } function ond_select_detail($nm,$ond2) { global $scr_width; global $multi_sw; $flist2 = ond_select_detail_s($nm,$ond2); $n = count_73($flist2); $tnm = $nm[2]; $tnm2 = rf_strimwidth($tnm, 0, $scr_width-12); $opt = array( "title" => "$tnm2 ($n 件)", "input_type" => 1, "page_control" => 1, "return_mes" => "戻る", "input_mes" => "どれを録音しますか", "mode" => 1, "multi" => $multi_sw, "confirm" => 0, "ht_selid" => "" ); $no2 = rf_pctl_disp($flist2, $opt); return $no2; } function ond_select_wdat($nm2) { global $tmpdir; global $radiru_vod_recdir; global $rec_extension; $sta = $nm2[1]; $dt = $nm2[2]; $fn2 = $nm2[3]; $fns = fn_edit($nm2[4]); $url = $nm2[5]; $pic = $nm2[6]; $sz = 200 - strlen($radiru_vod_recdir); $sz2 = strlen($fn2); if ($sz2 > $sz) { $fn2 = rf_strimwidth($fn2, 0, $sz); } $fn = fn_edit($fn2); $full_fn = $sta."_".$fn."_".$dt.".$rec_extension"; $wdat = get_wdata_vod($url, $sta, $fn, ";", $dt, $pic, $radiru_vod_recdir, $fns); return $wdat; } function ond_select_ex($wdat,$mcode_sel) { global $tmpdir; global $ex_radiru_vod; global $ex_radiru_gogaku; global $radiru_vod_recdir; global $radiru_vod_genre; global $radiru_gogaku_lang; global $rec_extension; global $scr_width; $ynmes1 = "録音しますか ? (y/N) : "; $ynmes2 = "録音しますか ? (y/N,r=聴取) : "; $ex_type = $ex_radiru_vod; $live = false; $flg = 0; $n = count_73($wdat); if ($n == 1) { $para = get_para($wdat[0], $ex_type); $arc = rf_program_archive_check($para); if ($arc === true) $live = true; } if ($live === true) { echo_msg(2, ""); $ynmes = $ynmes2; $flg = rfgw_check_sshd(); } else { $ynmes = $ynmes1; } $ans = echo_yesno(2, $ynmes); if ($live === true && ($ans == "r" || $ans == "R")) { echo_msg(2, ""); rfgw_reconnect_bd(); rfriends_live($ex_type,$para,$flg); rf_pause(); return 0; } if ($ans == "y" || $ans == "Y") { if ($mcode_sel == -1) { rf_batsh_rec($ex_radiru_gogaku, 0, 0, 0, $wdat); } else { rf_batsh_rec($ex_radiru_vod, 0, 0, 0, $wdat); } echo_msg(2, "聞き逃し録音開始しました。"); rf_pause(); return 0; } else { return 0; } return -1; } function get_wdata_vod($url, $sta, $fn, $fns, $dt, $pic, $genre, $kw) { global $radiru_vod; $para[0] = substr($dt, 0, 12); $para[1] = substr($dt, 0, 8).substr($dt, 13, 4); $para[2] = "0"; $para[3] = "0"; $para[4] = "0"; $para[5] = "0"; $para[6] = $sta; $para[7] = $fn; $para[8] = $fns; $para[9] = $pic; $para[10] = $kw; $para[11] = $url; $para[12] = ";"; $para[13] = ";"; $para[14] = ";"; $para[15] = ";"; $para[16] = ";"; $para[17] = ";"; $para[18] = ";"; $wdata = put_para($para, $radiru_vod); return $wdata; } function radiru_vod_rsv_ex($url, $dt, $cnt, $kwdat,$kwdat_ng, $mcode_sel, $mode) { global $radiru_vod_recdir; global $radiru_vod_genre; global $rsv_max; global $sort_flag; $range = 1; if ($cnt <= 0) $range = 0; $kwcnt = count_73($kwdat); $wdat = array(); if ($kwcnt <= 0) { return $wdat; } $st0 = date("Ymd", $dt); $st = strtotime($st0); $cnt0 = $cnt - 1; $en = strtotime("$cnt0 day", $st); $en0 = date("Ymd", $en); $sz = 200 - strlen($radiru_vod_recdir); $ond = ond_list($url, $mcode_sel); sort($ond); $ttl = count_73($ond); if ($ttl < 1) { return $wdat; } $wcnt = 0; $c =0; for ($no=0; $no<$ttl; $no++) { $c++; if ($c >= 20) { $c = 0; $no2 = $no + 1; if ($mode == 1) { echo_msg_temp(2, "$no2.."); } } $nm = $ond[$no]; $tdat = strtotime($nm[1]); $tnam = $nm[2]; $tcor = $nm[3]; $turl = $nm[4]; $tpic = $nm[5]; $media_code = $nm[7]; if (($sch = rf_get_html($turl,2)) === false) { rf_error_log("error : $tnam $turl"); continue; } $bch = ond_chconv($media_code); $json = json_decode($sch, true); @$json_detail = $json["main"]["detail_list"]; $cnt = count_73($json_detail); if ($cnt < 1) { continue; } for ($k=0; $k<$cnt; $k++) { $st0 = $json_detail[$k]["file_list"]; $cnt2 = count_73($st0); if ($cnt2 < 1) { continue; } $st2 = $st0[0]; $onair_date = $st2["onair_date"]; $open_time = $st2["open_time"]; $od = ond_date($onair_date , $open_time); $tm2 = strtotime(date("Ymd", $od)); if ($range == 1) { if ( $tm2 < $st) { continue; } } $fn2 = $st2["file_title"]; $fns2 = $st2["file_title_sub"]; $wd = $fn2.$fns2; $title = $st2["file_title"]; $desc = $st2["file_title_sub"]; $ch = $st2["aa_vinfo2"]; $ft = date("Ymd",$od); $ft2 = $od; $week_n = array("SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"); $ft3 = $week_n[date("w",$ft2)]; $prog_radiru = array( "ch" => "$ch", "title" => "$title", "desc" => "$desc", "time" => "$ft", "day" => "$ft3", "ptitle" => "$tnam", "ctitle" => "$tcor", "bch" => "$bch" ); $hit = ""; $kwcnt = count_73($kwdat); $hit = rf_hit($wd,$prog_radiru,$kwdat,$kwdat_ng); if ($hit == "") { continue; } $hitwd = $hit; $id = explode(";", $st2["aa_contents_id"]); $x99 = substr($id[4], 0, 2); if ($x99 == "99") { $t1 = date("YmdHi", $tm2); $t2= "0000"; } else { $id2 = explode("_", $id[4]); $t1 = date("YmdHi", strtotime($id2[0])); $t2 = date("Hi", strtotime($id2[1])); } $dt2 = $t1."_".$t2; $sta = explode(",", $id[2])[0]; if (strlen($fn2) > $sz) { $fn2 = rf_strimwidth($fn2, 0, $sz); } $fn = fn_edit($fn2); $fns = fn_edit($fns2); $url = $st2["file_name"]; $wdat[] = get_wdata_vod($url, $sta, $fn, $fns, $dt2, $tpic, $radiru_vod_genre, $hitwd); $wcnt++; } } if ($mode == 1) { } if ($sort_flag == 1) { asort($wdat); } elseif ($sort_flag == 2) { ksort($wdat); } return $wdat; } function gogaku_date($m_nen, $hdate) { $dt = str_replace("月", ",", $hdate); $dt = str_replace("日", ",", $dt); $dts = explode(",", $dt); if (count_73($dts) < 2) { $result = "00000000"; } else { $nen = (int)$m_nen; $tsuki = (int)$dts[0]; $hi = (int)$dts[1]; if ($tsuki <= 3) { $nen++; } $result = sprintf("%04d%02d%02d", $nen, $tsuki, $hi); } return $result; } function gogaku_opt($dty, $dtm, $dtw, $m, $stream, $sta, $imgurl, $pic, $genre) { global $scrdir; global $DS; $m_ttl = $m -> attributes() -> title; $m_dat = $m -> attributes() -> hdate; $m_koz = $m -> attributes() -> kouza; $m_cod = $m -> attributes() -> code; $m_fil = $m -> attributes() -> file; $m_nen = $m -> attributes() -> nendo; $m_pgc = $m -> attributes() -> pgcode; $st0 = sprintf($stream, $m_fil); $fns = explode(".", $m_fil); $pic0 = $imgurl.$pic; if ($dty == 0) { $dt0 = gogaku_date($m_nen, $m_dat); } else { $dt0 = sprintf("%04d%02d%02d", $dty, $dtm, $dtw); $m_ttl = $m_ttl."_".$m_dat; } $para[0] = $dt0."0000"; $para[1] = $dt0."0000"; $para[2] = 0; $para[3] = 0; $para[4] = 0; $para[5] = 0; $para[6] = $sta; $para[7] = $m_ttl; $para[8] = $fns[0]; $para[9] = $pic0; $para[10] = ";"; $para[11] = $st0; $para[12] = ";"; $para[13] = ";"; $para[14] = ";"; $para[15] = ";"; return $para; } function gogaku_program_disp($program) { $nmax = 0; foreach ($program as $pg) { $nmax++; $m_dat = $pg -> attributes() -> hdate; $tx = sprintf("%2d %s", $nmax, $m_dat); echo_msg(2, $tx); } return $nmax; } function gogaku_month_list($ttl, $dt) { $flist = array(); $nmax = count_73($dt); for ($j=0; $j<$nmax; $j++) { $jj = sprintf("%2d", $j); $dty = $dt[$j][0]; $dtm = $dt[$j][1]; $flist[] = sprintf("%s (%s/%s)", $ttl, $dty, $dtm); } return $flist; } function gogaku_month_calc() { $n = 24; $y = 2018; $m = 4; $dt = array(); for ($j=1; $j<=$n; $j++) { $dty = sprintf("%04d", $y); $dtm = sprintf("%02d", $m); $dt[] = [$dty,$dtm]; $m++; if ($m > 12) { $y++; $m = 1; } } return $dt; } function gogaku_month_calc_new() { $nw = time(); $nwy = (int)date("Y", $nw); $nwm = (int)date("m", $nw); if ($nwm >=1 && $nwm <= 6) { $y = $nwy - 1; $m = 4; $n = 9 + $nwm; } else { $y = $nwy; $m = 4; $n = $nwm - 3; } $dt = array(); for ($j=1; $j<=$n; $j++) { $dty = sprintf("%04d", $y); $dtm = sprintf("%02d", $m); $dt[] = [$dty,$dtm]; $m++; if ($m > 12) { $y++; $m = 1; } } rsort($dt); return $dt; } 