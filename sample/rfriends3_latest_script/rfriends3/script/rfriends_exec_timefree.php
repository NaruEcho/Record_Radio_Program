<?php
 function timefree_end($st_tm, $timefreenw_dat, $mes) { echo_prn(1, $mes); fin_unlink($timefreenw_dat); $en_tm = start_prn(1, "RfriendsDailyTimefree End"); rf_statistics($st_tm, $en_tm); } function timefree_go($area_code, $timefreenw_dat, $kwdat1,$kwdat1_ng, $dt, $cnt) { global $nowarea; global $area_code; global $rftrans; global $rftrans_timefree; global $ex_timefree; $pref = rf_edit_area($area_code); $narea = "$area_code,$pref($area_code)"; $kwcnt = count_73($kwdat1); if ($kwcnt == 0) { echo_prn(1, ""); echo_prn(1, "キーがありません。"); return false; } $nmax = timefree_rsv_ex_file($timefreenw_dat, $kwdat1,$kwdat1_ng, $dt, $cnt); $i2 = timefree_disp($timefreenw_dat); start_prn(1, "TimeFreeRec Start"); $ret = timefree_kwrec_ex($timefreenw_dat, 0); start_prn(1, "TimeFreeRec End"); echo_prn(2, " "); echo_prn(2, "[ 異常終了分を再実行します。]"); $i2 = timefree_disp($timefreenw_dat); if ($i2 > 0) { start_prn(1, "TimeFreeRec Start"); $ret = timefree_kwrec_ex($timefreenw_dat, 0); start_prn(1, "TimeFreeRec End"); } return; } require_once("rf_inc.php"); require_once("rf_reserve.php"); require_once("rf_radiko.php"); require_once("rf_radiko2.php"); require_once("rf_radiko3.php"); require_once("rf_timefree.php"); require_once("rf_downloader.php"); require_once("rf_menu_sub.php"); require_once("rf_upd_common.php"); require_once("rf_upd_system.php"); require_once("rf_gdrive.php"); $rfriends_mes = "ラジオ録音ツール"; $test_mode = 0; $msg_level = 1; $dt0 = -1; $cnt = 2; $argpara = "0,1,-1,2"; if ($argc == 2) { $argpara = $argv[1]; } $p = explode(",", $argpara); if (count_73($p) == 4) { $test_mode = $p[0]; $msg_level = $p[1]; $dt0 = $p[2]; $cnt = $p[3]; } $ex_type = $ex_timefree; if ($dt0 > 1) { $dt = $dt0; $dt0 = -intval((time() - $dt)/3600/24); } else { $dt = strtotime("$dt0 day"); } $dtdate = date("Y/m/d", $dt); fr_system_info($ex_timefree); echo_prn(1, ""); echo_prn(1, "para : ".$argpara); echo_prn(1,"timefree_keyword_type : $timefree_keyword_type"); auth_ex(0); $p = premium_check(); $mgn = disp_ntp(); $st_tm = start_prn(1, "Rfriends Timefree Start [$dtdate] $dt0 $cnt"); $head = "timefree_area"; $fn = make_fn("rfriends_timefree"); $timefreenw_dat = $tmpdir.$fn.".dat"; echo_prn(1, " "); echo_prn(1, $timefreenw_dat); if (premium_check() > 0) { $area_code = $premium_home_area_code; $pref = rf_edit_area($area_code); $narea = "$area_code,$pref"; $secmes = "ラジコプレミアム  メインステーション : $narea"; rf_disp_section($secmes, "+"); } else { $pref = rf_edit_area($area_code); $narea = "$area_code,$pref"; $secmes = "ラジコ : $narea"; rf_disp_section($secmes, "+"); } $main_area = $area_code; $kwdat1_ng = merge_keyword($ex_timefree,1); $kwdat1 = merge_keyword($ex_timefree,0); echo_prn(2, ""); timefree_go($area_code, $timefreenw_dat, $kwdat1,$kwdat1_ng, $dt, $cnt); fin_unlink($timefreenw_dat); if (premium_check() < 1) { $mes = ""; timefree_end($st_tm, $timefreenw_dat, $mes); exit; } $sta = rf_get_keyword('premium_station'); if (count_73($sta) == 0) { $mes = "premium_station が定義されていません。"; echo_prn(1, $mes); $en_tm = start_prn(1, "RadikoReserve End"); rf_statistics($st_tm, $en_tm); exit; } echo_prn(2, ""); foreach ($sta as $area) { $no = rf_convjp($area); if ($no == 0) { echo_prn(1, "premium_station 設定エラー ($area)"); continue; } $area_code = $area; $pref = rf_edit_area($area_code); $narea = "$area,$pref"; $secmes = "ラジコプレミアム  ステーション  : $narea"; rf_disp_section($secmes, "+"); if ($area == $main_area) { echo_prn(1, "このエリアは main_station と重複しています。"); } $area = strtolower($area_code); $parea = "premium_$area"; echo_prn(2, ""); $kwdat1_ng = merge_keyword_area($area_code, $ex_timefree,1); $kwdat1 = merge_keyword_area($area_code, $ex_timefree,0); timefree_go($area_code, $timefreenw_dat, $kwdat1,$kwdat1_ng, $dt, $cnt); fin_unlink($timefreenw_dat); } $mes = ""; timefree_end($st_tm, $timefreenw_dat, $mes); exit; 